<html>
	<head>
		<link rel="stylesheet" href="src/css/main.css">
		<script src="src/js/datasetmanager.js"></script>
		<script src="src/js/TnslGraph.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
		<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
		<script>
			const dataset = new DatasetManager()

			function onSetDatasetZip() {
				const fileInput = document.getElementById('datasetzip')
				const userapply = document.getElementById('userapply')
				const file = fileInput.files[0]

				if(file) {
					fileInput.setAttribute('disabled', 'disabled')
					userapply.setAttribute('disabled', 'disabled')
					dataset.setZip(file, (status)=>{
						fileInput.removeAttribute('disabled')
						userapply.removeAttribute('disabled')
						if(!status) {
							alert("Invalid file. Expecting exported tournesol dataset")
							fileInput.value = null
						}
					})
				}
			}

			function onApplyUsername() {
				// Show loading
				const loading = document.getElementById('loading_status')

				const userapply = document.getElementById('userapply')
				const usernameinpt = document.getElementById('username')
				const selectedUsername = usernameinpt.value

				loading.innerText = 'Loading dataset...'
				userapply.setAttribute('disabled', 'disabled')
				usernameinpt.setAttribute('disabled', 'disabled')

				// Prepare data
				dataset.loadUserData(selectedUsername, (isOk) => {
					if(!isOk) {
						userapply.removeAttribute('disabled')
						usernameinpt.removeAttribute('disabled')
						loading.innerText = 'IDLE (Set Dataset file, pick a username and then click on Apply)'
						return
					}

					const indivScores = dataset.individualScores.filter(c => c.criteria === 'largely_recommended')
					const filteredComparisons = dataset.comparisons.filter(c => c.criteria === 'largely_recommended')

					// Prepare data
					const graph = new TnslGraph()
					for(const c of filteredComparisons) {
						graph.addLink(c.video_a, c.video_b)
					}

					// Update stats
					document.getElementById("pub_vid").innerText = graph.data.nodes.length
					document.getElementById("pub_cmp").innerText = graph.data.links.length

					// groups
					const gm = {}
					graph.data.groups.forEach(g => gm[g.length] = (gm[g.length] || 0) + 1)
					const gs = Object.keys(gm)
					gs.sort((a,b)=>+a<+b?1:-1)
					document.getElementById("stt_groups").innerText = gs.map(size=>'' + size +(gm[size] > 1 ? `(x${gm[size]})` : '')).join(', ')

					// Add graph viz to viewport
					document.getElementById('graph').innerHTML = ''
					loading.innerText = 'Drawing graph...'
					document.getElementById('graph').appendChild(graph.getDiv(() => {
						userapply.removeAttribute('disabled')
						usernameinpt.removeAttribute('disabled')
						loading.innerText = 'IDLE (Drawing complete)'
					}))
				})
			}


		</script>
	</head>
	<body>
		<div id="header">
			<div class="hf">
				<div>Tournesol Entangler</div>
				<div>
					Dataset:
					<input type="file" id="datasetzip" accept=".zip" onchange="onSetDatasetZip()"/>
				</div>
				<div>User: <input type="text" id="username"/><button id="userapply" onclick="onApplyUsername()">Apply</button></div>
			</div>
		</div>
		<div id="content">
			<div id="graph"></div>
			<div id="stats">
				<div style="background: #F4F8E8; width:100%; padding: .25em;"><span id="loading_status">IDLE (Please set Dataset file, pick a username, and then click on Apply)</span></div>
				<div>Public videos: <span id="pub_vid">0</span></div>
				<div>Public comparisons: <span id="pub_cmp">0</span></div>
				<div>Connected components: <span id="stt_groups">0</span></div>
			</div>
		</div>
		<div id="footer">
			<div class="hf">
				<span>Build 2024-10-30 - INDEV VERSION (= Contains bugs)</span>
				<span>by @NatNgs</span>
				<a href="https://tournesol.app/about">About Tournesol.app</a>
			</div>
		</div>
	</body>
</html>
