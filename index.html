<html>
	<head>
		<link rel="stylesheet" href="src/css/main.css">
		<script src="src/js/datasetmanager.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
		<script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
		<script>
			const dataset = new DatasetManager()

			function onSetDatasetZip() {
				const fileInput = document.getElementById('datasetzip')
				const userapply = document.getElementById('userapply')
				const file = fileInput.files[0]

				if(file) {
					fileInput.setAttribute('disabled', 'disabled')
					userapply.setAttribute('disabled', 'disabled')
					dataset.setZip(file, ()=>{
						fileInput.removeAttribute('disabled')
						userapply.removeAttribute('disabled')
					})
				}
			}

			function onApplyUsername() {
				const userapply = document.getElementById('userapply')
				const usernameinpt = document.getElementById('username')
				const selectedUsername = usernameinpt.value

				userapply.setAttribute('disabled', 'disabled')
				usernameinpt.setAttribute('disabled', 'disabled')

				// Prepare data
				dataset.loadUserData(selectedUsername, (isOk) => {
					if(!isOk) {
						userapply.removeAttribute('disabled')
						usernameinpt.removeAttribute('disabled')
						return
					}

					const indivScores = dataset.individualScores.filter(c => c.criteria === 'largely_recommended')
					const filteredComparisons = dataset.comparisons.filter(c => c.criteria === 'largely_recommended')

					// Prepare data
					const nodes_vid_to_index = {}
					const nodes = [] // {index: vid}
					const links = [] // {source: vid, target: vid}

					for(const c of filteredComparisons) {
						if(!nodes_vid_to_index[c.video_a]) {
							nodes_vid_to_index[c.video_a] = nodes.length
							nodes.push({id: c.video_a, group: c.video_a[0]})
						}
						if(!nodes_vid_to_index[c.video_b]) {
							nodes_vid_to_index[c.video_b] = nodes.length
							nodes.push({id: c.video_b, group: c.video_b[0]})
						}
						links.push({source: c.video_a, target: c.video_b})
					}

					// Update stats
					document.getElementById("pub_vid").innerText = nodes.length
					document.getElementById("pub_cmp").innerText = links.length

					// Make d3 chart
					d3chart({nodes:nodes, links:links})

					userapply.removeAttribute('disabled')
					usernameinpt.removeAttribute('disabled')
				})
			}

			function d3chart(data) {
				const links = data.links.map(d => ({...d}))
				const nodes = data.nodes.map(d => ({...d}))

				// Specify the color scale.
				const color = d3.scaleOrdinal(d3.schemeCategory10)

				// Create a simulation with several forces
				const width = 720, height = 720
				const simulation = d3.forceSimulation(nodes)
					.force('center', d3.forceCenter(0,0))
					.force("repulse", d3.forceManyBody().distanceMax(width))
					.velocityDecay(0.01)
					.force('walls', (alpha)=>{ // Walls around the bounding box
						nodes.map((node)=>{
							if(node.x > width) {
								node.x = width
								node.vx = 0
							} else if(node.x < -width) {
								node.x = -width
								node.vx = 0
							}
							if(node.y > height) {
								node.y = height
								node.vy = 0
							} else if(node.y < -height) {
								node.y = -height
								node.vy = 0
							}
						})
					})
					.force("attract", d3.forceLink(links).id(d => d.id))

				// Create div
				const svg = d3.create("svg")
					.attr("viewBox", [-width, -height, width*2, height*2])

				// Add a line for each link, and a circle for each node.
				const link = svg.append("g")
					.attr("stroke", "#888")
					.attr("stroke-opacity", 0.5)
					.selectAll("line")
					.data(links)
					.join("line")

				const node = svg.append("g")
					.selectAll("circle")
					.data(nodes)
					.join("circle")
					.attr("r", 3)
					.attr("fill", d => color(d.group))

				// Set the position attributes of links and nodes each time the simulation ticks.
				simulation.on("tick", () => {
					link
						.attr("x1", d => d.source.x)
						.attr("y1", d => d.source.y)
						.attr("x2", d => d.target.x)
						.attr("y2", d => d.target.y)

					node
						.attr("cx", d => d.x)
						.attr("cy", d => d.y)
				})

				// Add div to viewport
				document.getElementById('graph').innerHTML = ''
				document.getElementById('graph').appendChild(svg.node())
			}

		</script>
	</head>
	<body>
		<div id="header">
			<div class="hf">
				<div>Tournesol Comparisons Entangler</div>
				<div>
					Dataset:
					<input type="file" id="datasetzip" accept=".zip" onchange="onSetDatasetZip()"/>
				</div>
				<div>User: <input type="text" id="username"/><button id="userapply" onclick="onApplyUsername()">Apply</button></div>
			</div>
		</div>
		<div id="content">
			<div id="graph"></div>
			<div id="stats">
				<div>Public videos: <span id="pub_vid">0</span></div>
				<div>Public comparisons: <span id="pub_cmp">0</span></div>
			</div>
		</div>
		<div id="footer">
			<div class="hf">
				Test footer
			</div>
		</div>
	</body>
</html>
